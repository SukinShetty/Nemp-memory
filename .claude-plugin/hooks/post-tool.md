# Post Tool Use Hook: Auto-Capture & Auto-Sync

This hook fires after tool uses to automatically capture activities and sync memories to CLAUDE.md.

## Trigger
- Event: `PostToolUse`
- Filter: Only for `Edit`, `Write`, `Bash` tools
- Timing: Immediately after tool execution completes

## Instructions

When this hook fires after a tool use, follow these steps:

---

## Part A: Auto-Capture (Activity Logging)

### 1. Check Auto-Capture Status

First, check if auto-capture is enabled by reading `.nemp-pro/config.json`.

**If the file doesn't exist or `autoCapture.enabled` is `false`, skip to Part B.**

### 2. Analyze Tool Action (if enabled)

Capture metadata about what happened based on the tool:

**For Edit:**
```json
{
  "tool": "Edit",
  "file": "<file-path-that-was-edited>",
  "action": "modified",
  "timestamp": "<ISO-8601-timestamp>"
}
```

**For Write:**
```json
{
  "tool": "Write",
  "file": "<file-path-that-was-created>",
  "action": "created",
  "timestamp": "<ISO-8601-timestamp>"
}
```

**For Bash:**
Only capture significant commands (git, npm, bun, build, test, deploy):
```json
{
  "tool": "Bash",
  "command": "<command-category>",
  "details": "<brief-description>",
  "timestamp": "<ISO-8601-timestamp>"
}
```

Skip capturing for:
- `ls`, `cat`, `pwd`, `cd` (navigation)
- `echo`, `mkdir` in `.nemp-pro/` or `.nemp/` (internal operations)
- Any command that reads `.nemp-pro/` or `.nemp/` files

### 3. Append to Activity Log

Read existing activity log from `.nemp-pro/activity.log`, parse as JSON array.
If file doesn't exist, start with empty array `[]`.

Append the new entry to the array and write back to `.nemp-pro/activity.log`.

**Activity Log Format:**
```json
[
  {
    "timestamp": "2026-01-30T15:30:00Z",
    "tool": "Edit",
    "file": "src/auth/login.ts",
    "action": "modified"
  },
  {
    "timestamp": "2026-01-30T15:32:00Z",
    "tool": "Bash",
    "command": "git",
    "details": "committed changes"
  }
]
```

### 4. Exclusion Rules for Auto-Capture

Do NOT capture activities for:
- Files in `node_modules/**`
- Files in `.git/**`
- Files in `.nemp-pro/**` (to avoid infinite loops)
- Files in `.nemp/**` (to avoid infinite loops)
- Log files (`*.log`)
- Lock files (`package-lock.json`, `bun.lockb`, etc.)

---

## Part B: Auto-Sync (CLAUDE.md Updates)

### 1. Check Auto-Sync Status

Read `.nemp/config.json` and check if `autoSync === true`.

```bash
[ -f ".nemp/config.json" ] && cat .nemp/config.json
```

**If the file doesn't exist or `autoSync` is `false` or not set, STOP HERE.**

### 2. Check If Sync Should Trigger

Auto-sync should ONLY trigger after these Nemp commands complete:
- `/nemp:save` - after saving a memory
- `/nemp:init` - after initializing project
- `/nemp:forget` - after deleting a memory

**How to detect:** Check if the recent tool actions were writing to `.nemp/memories.json`.

If the `Write` tool was used on `.nemp/memories.json`, trigger auto-sync.

### 3. Perform Silent Sync to CLAUDE.md

When auto-sync triggers:

**Step 3a: Read all memories**
```bash
[ -f ".nemp/memories.json" ] && cat .nemp/memories.json
```

**Step 3b: Generate the Nemp section**

Format memories as markdown (same format as `/nemp:export`):

```markdown
## Project Context (via Nemp Memory)

> Auto-generated by Nemp Memory. Last updated: [YYYY-MM-DD HH:MM]

### [Category Name]

| Key | Value |
|-----|-------|
| **key-name** | value here |

---
```

For organizing memories, use these categories based on key names:
- **Workspace Info**: keys containing `project-name`, `workspace`, `subprojects`
- **Tech Stack**: keys containing `stack`, `framework`, `database`, `auth`, `styling`, `testing`
- **Global Preferences**: other preference-like keys
- Uncategorized keys go in a general table

**Step 3c: Check CLAUDE.md**
```bash
[ -f "CLAUDE.md" ] && cat CLAUDE.md
```

**Step 3d: Update CLAUDE.md**

- **If CLAUDE.md does NOT exist:** Create it with just the Nemp section
- **If CLAUDE.md exists with Nemp section:** Replace the section between `## Project Context (via Nemp Memory)` and the next `---` or `## ` heading
- **If CLAUDE.md exists without Nemp section:** Append the Nemp section at the end

### 4. Silent Operation with Minimal Output

**IMPORTANT:** This hook should operate mostly silently.

- Do NOT output verbose messages
- After sync completes, output ONLY: `Synced`
- If there's an error, report it briefly

### 5. Exclusion Rules for Auto-Sync

Do NOT trigger auto-sync for:
- Writing to any file other than `.nemp/memories.json`
- Reading operations
- Navigation commands

---

## Configuration

### Auto-Capture Config (`.nemp-pro/config.json`)

```json
{
  "version": "1.0",
  "autoCapture": {
    "enabled": true,
    "tools": ["Edit", "Write", "Bash"],
    "excludePaths": [
      "node_modules/**",
      ".git/**",
      "*.log",
      ".nemp-pro/**",
      ".nemp/**"
    ]
  }
}
```

### Auto-Sync Config (`.nemp/config.json`)

```json
{
  "autoSync": true
}
```

---

## Toggle Commands

**Auto-Capture:**
- `/nemp:auto-capture on` - Enable activity capture
- `/nemp:auto-capture off` - Disable activity capture
- `/nemp:auto-capture status` - Check status

**Auto-Sync:**
- `/nemp:auto-sync on` - Enable CLAUDE.md sync
- `/nemp:auto-sync off` - Disable CLAUDE.md sync
- `/nemp:auto-sync status` - Check status

---

## Example Flow

1. User runs `/nemp:auto-sync on` -> `autoSync: true` saved to `.nemp/config.json`
2. User runs `/nemp:save api-key Use env var API_KEY`
3. Save command writes to `.nemp/memories.json`
4. Post-tool hook detects write to `.nemp/memories.json`
5. Hook checks `.nemp/config.json` -> `autoSync: true`
6. Hook reads `.nemp/memories.json`, generates markdown
7. Hook updates CLAUDE.md with new Nemp section
8. Output: `Synced`

---

## Pattern Analysis (Future Enhancement)

At session end, the activity log can be analyzed for patterns:
- Files edited 3+ times -> important files
- Repeated commands -> workflow patterns
- Consistent choices -> preferences

These insights can be promoted to permanent memories with user confirmation.
